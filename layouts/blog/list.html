{{ define "main" }}
  {{ $posts := .Pages.ByDate.Reverse }}
  {{ $openAll := or (eq (site.Params.archiveOpenAll | default "") "all")
                   (eq (.Param "archiveOpenAll" | default "") "all") }}
  
  <p class="archive-controls">
    <a href="{{ .RelPermalink }}">Collapse all</a>
  </p>
  
  {{ range $year := $posts.GroupByDate "2006" }}
    {{ $yearID := printf "y-%s" $year.Key }}
    <details class="archive-year" id="{{ $yearID }}" {{ if $openAll }}open{{ end }}>
      <summary class="archive-year__summary">
        <span class="archive-year__label">{{ $year.Key }}</span>
        <span class="archive-year__count">({{ len $year.Pages }})</span>
      </summary>
      
      {{ range $month := $year.Pages.GroupByDate "2006-01" }}
        {{ $full := printf "%s-01" $month.Key }}
        {{ $monthID := printf "m-%s" $month.Key }}
        <h3 class="archive-month__heading" id="{{ $monthID }}">{{ time $full | time.Format "January 2006" }}</h3>
        
        <ul class="archive-list">
          {{ range $p := $month.Pages.ByDate.Reverse }}
            <li>
              <span class="archive-date">{{ $p.Date.Format "Jan 01 2006" }}</span>
              <a href="{{ $p.RelPermalink }}">{{ $p.Title }}</a>
            </li>
          {{ end }}
        </ul>
      {{ end }}
    </details>
  {{ end }}
{{ end }}
