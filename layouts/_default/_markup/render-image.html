<!--
    Markdown Image Syntax Example:
    ![Screenshot of the dashboard](dashboard.jpg "The main dashboard view")
    
    Hugo Processing Benefits:
    • Convert to WebP for modern browsers
    • Resize large images to 960px max width  
    • Add lazy loading and proper dimensions
    • Wrap in figure/picture elements for better semantics
-->

{{ $src := .Page.Resources.GetMatch (printf "%s" (.Destination | safeURL)) }}
{{ if $src }}
  {{ $data := newScratch }}
  {{ if gt $src.Width 1100 }}
    {{ $data.Set "webp" ($src.Resize "960x webp q90") }}
    {{ $data.Set "large" ($src.Resize "1200x webp q85") }}
    {{ $data.Set "fallback" ($src.Resize "960x q90") }}
  {{ else }}
    {{ $data.Set "webp" ($src.Resize (printf "%dx%d webp q90" $src.Width $src.Height)) }}
    {{ $data.Set "large" $src }}
    {{ $data.Set "fallback" ($src.Resize (printf "%dx%d q90" $src.Width $src.Height)) }}
  {{ end }}
  
  {{ $webp := $data.Get "webp" }}
  {{ $large := $data.Get "large" }}
  {{ $fallback := $data.Get "fallback" }}
  
  <figure>
    <!-- GLightbox wrapper link -->
    <a href="{{ $large.RelPermalink }}" 
       class="glightbox" 
       data-gallery="blog-images"
       data-title="{{ with .Title }}{{ . }}{{ else }}{{ .Text }}{{ end }}">
      <picture>
        <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
        <img src="{{ $fallback.RelPermalink }}" 
             alt="{{ .Text }}" 
             loading="lazy" 
             decoding="async" 
             width="{{ $webp.Width }}" 
             height="{{ $webp.Height }}">
      </picture>
    </a>
    {{ with .Title }}<figcaption>{{ . | markdownify }}</figcaption>{{ end }}
  </figure>
{{ else }}
  <!-- Fallback for images not in page bundle -->
  <img src="{{ .Destination | safeURL }}" alt="{{ .Text }}" {{ with .Title }}title="{{ . }}"{{ end }}>
{{ end }}

