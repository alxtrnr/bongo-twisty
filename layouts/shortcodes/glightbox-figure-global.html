{{- $src := .Get "src" -}}
{{- $caption := .Get "caption" -}}
{{- $alt := .Get "alt" -}}
{{- $image := "" -}}

{{- $pageResource := .Page.Resources.GetMatch $src -}}
{{- if $pageResource -}}
  {{- $image = $pageResource -}}
{{- else -}}
  {{- $galleryPage := .Site.GetPage "/gallery/postbox_toppers" -}}
  {{- if $galleryPage -}}
    {{- $filename := path.Base $src -}}
    {{- $galleryResource := $galleryPage.Resources.GetMatch $filename -}}
    {{- if $galleryResource -}}
      {{- $image = $galleryResource -}}
    {{- end -}}
  {{- end -}}
  {{- if not $image -}}
    {{- $globalResource := resources.Get $src -}}
    {{- if $globalResource -}}
      {{- $image = $globalResource -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $image -}}
  {{- $thumb := $image.Fill "400x300 Smart" }}
  {{- $displayCaption := or $caption $image.Title -}}
  {{- $altText := or $alt $image.Params.alt $displayCaption -}}
  <figure>
    <a href="{{ $image.RelPermalink }}" class="glightbox" data-title="{{ $displayCaption }}">
      <img src="{{ $thumb.RelPermalink }}" alt="{{ $altText }}" title="{{ $displayCaption }}" width="{{ $thumb.Width }}" height="{{ $thumb.Height }}">
    </a>
    <figcaption>{{ $displayCaption }}</figcaption>
  </figure>
{{- else -}}
  <figure>
    <a href="{{ $src | relURL }}" class="glightbox" data-title="{{ $caption }}">
      <img src="{{ $src | relURL }}" alt="{{ $alt }}">
    </a>
    <figcaption>{{ $caption }}</figcaption>
  </figure>
{{- end -}}
